# Feature Specification: 団体機能（団体戦＋団体内イベント）

**Feature Branch**: `103-group-feature`
**Created**: 2026-02-02
**Status**: Draft
**Owner**: product

## Overview

団体を「団体戦」と「団体内イベント」の共通コンテナとして提供し、招待コード制で参加を統制しながらQRで入力負荷を軽減する。権限（団体管理者/団体運営/団体一般）を導入し、成績を個人と団体の両方に整合的に反映して二重計上を防ぐ。

### Terminology

| UI表示 | 内部キー | 説明 |
|--------|----------|------|
| 団体 | group | グループの総称 |
| 団体管理者 | group_owner | グループの作成者・最高権限者 |
| 団体運営 | group_organizer | イベント運営権限を持つメンバー |
| 団体一般 | group_member | 一般参加メンバー |
| 運営管理者 | platform_admin | プラットフォーム全体の管理者 |

### Fixed Navigation

団体トップページには以下のエントリーポイントを常時表示：
- **団体戦**: 団体間での競技参加
- **イベント**: 団体内イベントの開催・参加

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 団体を作成する (Priority: P1)

ユーザーが新しい団体を作成し、団体管理者として招待コードを発行してメンバーを募集できるようになる。

**Why this priority**: 団体機能の基盤となる機能。団体が存在しないと他のすべての機能が成り立たない。

**Independent Test**: 団体作成→招待コード発行→QR表示まで単独でテスト可能。作成者が団体管理者として設定されることを確認。

**Acceptance Scenarios**:

1. **Given** ログイン済みユーザー, **When** 団体作成画面で団体名と説明を入力して作成ボタンを押す, **Then** 団体が作成され、作成者が団体管理者として登録される
2. **Given** 団体管理者, **When** 団体トップページを開く, **Then** 招待コード（7日有効/100名上限）が自動生成されており、QRコードとして表示できる
3. **Given** 団体管理者, **When** 招待コードの再生成を実行する, **Then** 新しい招待コードが発行され、旧コードは無効化される

---

### User Story 2 - 招待コードで団体に参加する (Priority: P1)

ユーザーが招待コードまたはQRコードを使って団体に参加できる。

**Why this priority**: メンバー参加がないと団体として機能しない。団体作成と同等に重要。

**Independent Test**: 招待コード入力→参加完了まで単独でテスト可能。QR読み取りからの参加も同一ロジックで検証。

**Acceptance Scenarios**:

1. **Given** ログイン済みユーザー, **When** 有効な招待コードを入力する, **Then** 団体一般メンバーとして登録され、団体トップページにアクセスできる
2. **Given** ログイン済みユーザー, **When** QRコードをスキャンしてディープリンク（/join?groupId={id}&code={code}）を開く, **Then** 招待コード入力と同じ検証を経て参加処理が完了する
3. **Given** ユーザー, **When** 期限切れ/無効化済み/上限到達の招待コードを使用する, **Then** 参加は拒否され、適切なエラーメッセージが表示される
4. **Given** 未ログインユーザー, **When** 招待リンクを開く, **Then** ログインを促され、ログイン完了後に参加処理が継続される

---

### User Story 3 - 団体内イベントを開催する (Priority: P2)

団体管理者または団体運営がイベントを作成・公開し、メンバーが参加できる。

**Why this priority**: 団体の主要なユースケースの一つ。団体存在後に必要となる機能。

**Independent Test**: イベント作成→公開→メンバー参加まで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 団体管理者または団体運営, **When** イベント作成画面で必要情報を入力して作成する, **Then** 下書き状態のイベントが作成される
2. **Given** 下書きイベント, **When** 団体管理者/団体運営が公開ボタンを押す, **Then** イベントが公開され、メンバーが閲覧・参加できる
3. **Given** 公開済みイベント, **When** 団体一般メンバーが参加ボタンを押す, **Then** イベント参加者として登録される
4. **Given** 団体内イベント（isOfficial=false）, **When** 集計処理が実行される, **Then** 公式ランキング・称号には反映されない

---

### User Story 4 - 団体戦に参加する (Priority: P2)

団体メンバーが団体を代表して競技に参加し、成績が団体に紐づけられる。

**Why this priority**: 団体間競争という核心機能。イベント機能と並ぶ主要ユースケース。

**Independent Test**: 競技開始時に団体紐づけ→成績記録→団体集計反映まで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 団体メンバー, **When** 団体戦に参加する, **Then** 競技開始時に所属団体（affiliatedGroupId）が記録される
2. **Given** 競技が開始された状態, **When** 競技中または競技後にユーザーが団体を退会/移籍する, **Then** その競技の団体紐づけは変わらない（開始時点で凍結）
3. **Given** 競技結果が確定した状態, **When** 集計処理が実行される, **Then** 個人成績と団体成績の両方に反映される（二重計上なし）

---

### User Story 5 - 団体メンバーのロールを管理する (Priority: P2)

団体管理者がメンバーのロールを変更したり、メンバーを除名したりできる。

**Why this priority**: 運用上必須の管理機能。団体運営には権限管理が不可欠。

**Independent Test**: ロール変更→権限反映確認まで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 団体管理者, **When** メンバーのロールを団体運営に変更する, **Then** そのメンバーはイベント管理権限を得る
2. **Given** 団体管理者, **When** メンバーを除名する, **Then** メンバーは団体から除外され、退会日時が記録される
3. **Given** 団体運営, **When** 他メンバーのロール変更を試みる, **Then** 権限不足で操作が拒否される

---

### User Story 6 - プラットフォーム管理者が介入する (Priority: P3)

運営管理者がポリシー違反の団体やユーザーに対して措置を取れる。

**Why this priority**: 運用安全性のための管理機能。初期リリース後でも対応可能。

**Independent Test**: 団体停止/ユーザーBAN→アクセス制限確認まで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 運営管理者, **When** ポリシー違反の団体を停止する, **Then** 団体ステータスがsuspendedになり、メンバーは閲覧のみ可能になる
2. **Given** 運営管理者, **When** ユーザーをBANする, **Then** そのユーザーはプラットフォーム全体からアクセスできなくなる
3. **Given** 運営管理者, **When** 管理操作を実行する, **Then** 監査ログに操作者・対象・日時が記録される

---

### Edge Cases

- 団体管理者が退会した場合、どうなるか？
  - **対応**: 団体管理者は退会不可。先に別のメンバーに管理者権限を移譲する必要がある
- 招待コード上限(100名)に到達した場合は？
  - **対応**: 新規参加は拒否。管理者がコード再生成で上限リセット可能
- 同一ユーザーが複数団体に所属して同じ競技に参加した場合は？
  - **対応**: 1競技につき1団体のみ紐づけ可能。参加時に団体を選択する仕様
- 競技中に招待コードが期限切れ/無効化された場合は？
  - **対応**: 進行中の競技には影響なし。新規参加のみ制限

## Requirements *(mandatory)*

### Functional Requirements

#### 団体管理

- **FR-001**: システムは、ログインユーザーが団体を作成し、自動的に団体管理者として登録される機能を提供しなければならない
- **FR-002**: システムは、団体作成時に招待コード（デフォルト: 7日有効/100名上限）を自動生成しなければならない
- **FR-003**: 招待コードは平文ではなくハッシュ値のみを保存しなければならない
- **FR-004**: 団体管理者のみが招待コードの再生成・無効化を実行できなければならない
- **FR-005**: システムは、招待コード入りURL（/join?groupId={id}&code={code}）をQRコードとして表示できなければならない

#### 参加管理

- **FR-006**: システムは、招待コードの検証（ハッシュ比較、期限、無効化状態、上限）を行わなければならない
- **FR-007**: 参加成功時、joinCountをトランザクション内でインクリメントしなければならない
- **FR-008**: 参加の成功/失敗は監査ログに記録されなければならない
- **FR-009**: 参加処理にはログインが必須である
- **FR-010**: 招待コードによる参加とQR/ディープリンクによる参加は同一の検証ロジックを使用しなければならない

#### ロール・権限管理

- **FR-011**: 団体管理者は、メンバーのロール変更（owner/organizer/member）を実行できなければならない
- **FR-012**: 団体管理者は、メンバーを除名（status: left、leftAt記録）できなければならない
- **FR-013**: 団体運営は、イベントの作成・編集・公開/非公開を実行できなければならない
- **FR-014**: 団体運営は、招待コード管理・ロール変更・メンバー除名を実行できてはならない
- **FR-015**: 団体一般は、イベント参加・閲覧・団体戦参加のみ可能でなければならない

#### イベント管理

- **FR-016**: 団体管理者/団体運営は、団体内イベントを作成できなければならない
- **FR-017**: イベントはデフォルトでisOfficial=falseで作成されなければならない
- **FR-018**: isOfficial=falseのイベント結果は公式ランキング・称号計算から除外されなければならない
- **FR-019**: イベントの公開範囲はデフォルトで団体内限定（group_only）でなければならない

#### 競技・成績管理

- **FR-020**: 競技開始時にaffiliatedGroupIdを設定し、以降は変更不可（immutable）としなければならない
- **FR-021**: 1つの競技は最大1つの団体にのみ紐づけられなければならない
- **FR-022**: 競技参加には明示的な参加記録が必要であり、自動参加は禁止しなければならない
- **FR-023**: 退会・移籍後も過去の競技の団体紐づけは変更されてはならない
- **FR-024**: 集計処理は、同一のmatch_logから個人成績と団体成績の両方を派生させなければならない

#### プラットフォーム管理

- **FR-025**: 運営管理者は、ユーザーの停止/BAN、データ調査・修正、団体の停止/削除を実行できなければならない
- **FR-026**: 運営管理者の操作は全て監査ログに記録されなければならない
- **FR-027**: 運営管理者は日常的な団体運営に介入すべきではない

#### UI/ナビゲーション

- **FR-028**: 団体タブを新設し、団体一覧/作成/管理機能を提供しなければならない
- **FR-029**: 個人タブ（プロフィール等）に団体登録（参加）への導線を追加しなければならない
- **FR-030**: 団体トップページには「団体戦」「イベント」のエントリーポイントを常時表示しなければならない

### Key Entities

- **Group（団体）**: 団体の基本情報（名前、説明、アイコン、ステータス）を管理。ownerUserIdで管理者を識別
- **GroupMembership（団体メンバーシップ）**: ユーザーと団体の紐づけ、ロール（owner/organizer/member）、参加/退会日時を管理
- **GroupInvite（招待コード）**: ハッシュ化された招待コード、有効期限、上限数、使用数、無効化状態を管理
- **GroupEvent（団体内イベント）**: イベント情報、公開状態、公式フラグ（isOfficial）を管理
- **Match（競技）**: 競技結果、参加者、紐づけ団体（affiliatedGroupId）を管理。startedAt時点で凍結

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは2分以内に団体を作成し、招待コード/QRを発行できる
- **SC-002**: ユーザーは30秒以内に招待コードまたはQRコードで団体に参加できる
- **SC-003**: 招待コードの検証エラー率（無効/期限切れ/上限）は明確なエラーメッセージとともに100%適切に処理される
- **SC-004**: 団体内イベント（isOfficial=false）の結果が公式集計に含まれる事故が0件である
- **SC-005**: 1競技が複数団体に計上される二重計上事故が0件である
- **SC-006**: 退会・移籍後に過去競技の団体紐づけが変更される事故が0件である
- **SC-007**: 招待コードの平文がデータベースに保存されることが0件である
- **SC-008**: 権限を持たないユーザーによる管理操作（招待コード再生成、ロール変更等）が100%拒否される
- **SC-009**: 全ての重要操作（参加、退会、ロール変更、停止等）に対して監査ログが100%記録される

## Assumptions

- 既存の認証システム（Firebase Auth）を使用する
- 既存のmatch_log構造にaffiliatedGroupIdフィールドを追加可能
- QRコード生成は既存のライブラリを使用可能
- レート制限は既存のインフラ機能で対応可能
