# Feature Specification: 歌合・節気別歌位確定システム

**Feature Branch**: `102-utaawase-sekki-ranking`
**Created**: 2026-01-27
**Status**: Draft
**Input**: 百人一首Web競技サービスにおいて、歌合の記録を「四季（節気）区分」で集計し、昇級・昇段・称号（歌位）を「凍結→確定→公開」でサーバ側が一貫して確定する。

## Clarifications

### Session 2026-01-27

- Q: 級位の最高位は六級（五級は存在しない）か、五級が最高位か？ → A: 六級が最高位（五級は存在しない）。初級→十級→九級→八級→七級→六級の6段階。
- Q: 伝位の「上位入賞」はシーズンランキングで何位以内を指すか？ → A: 上位1/3以内（シーズンランキングの上位33%）。
- Q: 級位検定の対象札は各級位でどう割り当てるか？ → A: 十級=一字決まり、九級=二字、八級=三字、七級=四字以上含む部分札、六級=全100首。決まり字の少ない札から段階的に増やす。
- Q: 累積スコアはシーズン内の全matchスコアの合計か、ベストスコアのみか？ → A: ベスト3回のスコア合計。
- Q: 各級位の検定における最低出題数は？ → A: 十級=7問、九級=10問、八級=15問、七級=25問、六級=50問（段階的に増加）。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 級位検定（即時昇級） (Priority: P1)

プレイヤーは「級位検定」（kyui_exam）を受験し、合格条件を満たすと即座に昇級する。初級から六級まで段階的に昇級でき、六級到達で段位の部への参加資格（dan_eligible）を得る。

**Why this priority**: 級位検定は最も多くのユーザーが最初に体験する昇格パスであり、即時フィードバックによりモチベーションを維持できる。他の昇格機能の前提条件でもある。

**Independent Test**: 検定を実施し、合格条件を満たした場合に即座に昇級が反映されることを確認する。

**Acceptance Scenarios**:

1. **Given** 初級のプレイヤーが検定を開始, **When** 一字決まり札で正答率80%以上を達成, **Then** 十級に昇級し、user_progressが更新される
2. **Given** 七級のプレイヤーが検定を受験, **When** 全100首・正答率80%以上を達成, **Then** 六級に昇級し、dan_eligibleフラグがtrueに設定される
3. **Given** 十級のプレイヤーが九級の条件と八級の条件を同時に満たす検定結果を出した, **When** 昇級判定が行われる, **Then** 九級にのみ昇級する（飛び級禁止）
4. **Given** プレイヤーが検定を開始, **When** 合格条件を満たさない, **Then** 級位は変化せず、検定記録のみ保存される

---

### User Story 2 - 歌合イベント記録と四季区分割当 (Priority: P1)

節気カレンダーの立春/立夏/立秋/立冬の境界日時に基づき、各シーズン（春戦/夏戦/秋戦/冬戦）が自動生成される。既存の公式競技セッション（OfficialPage）の結果がmatchイベントとして自動保存され、イベント開始日時（Asia/Tokyo）から四季区分が自動割当される。参加者数はシーズンのエントリー数から算出され、24名以上でofficial、23名以下でprovisionalに自動分類される。順位はシーズン内の累積スコアによるランキングで決定される。

**Why this priority**: 全ての昇段・歌位確定の基盤となるデータ入力機能であり、これがなければ他の機能が成立しない。

**Independent Test**: 歌合イベントを保存し、四季区分と記録格（公式/暫定）が正しく割り当てられることを確認する。

**Acceptance Scenarios**:

1. **Given** 2026年3月1日（立春〜立夏の間）に歌合が開催, **When** イベント記録を保存, **Then** seasonId=spring, seasonYear=2026が設定される
2. **Given** 参加者30名の競技, **When** イベント記録を保存, **Then** tier=officialに分類される
3. **Given** 参加者15名の競技, **When** イベント記録を保存, **Then** tier=provisionalに分類される
4. **Given** 検定（kyui_exam）イベント, **When** イベント記録を保存, **Then** tier=nullが設定される（検定は公式/暫定の区分対象外）
5. **Given** 2026年11月8日（立冬後）に歌合が開催, **When** イベント記録を保存, **Then** seasonId=winter, seasonYear=2026が設定される

---

### User Story 3 - 節気カレンダーとルールセットの投入 (Priority: P1)

節気カレンダーの境界日時は、可能であれば外部天文APIから自動取得し、APIが利用不可の場合は運営が管理画面から手動入力する。ルールセット（各級位/段位/伝位の昇格条件）は運営がシステムに投入する。これにより四季区分の境界とプロモーション条件が定義される。

**Why this priority**: 四季区分と昇格ルールの基盤データであり、他の全機能の前提条件。

**Independent Test**: カレンダーとルールセットを投入し、正しく読み込まれることを確認する。

**Acceptance Scenarios**:

1. **Given** 運営が2026年の節気カレンダーを投入, **When** 保存が完了, **Then** risshun/rikka/risshuu/rittou/risshun_nextの5つの境界日時と、spring/summer/autumn/winterの4期間が登録される
2. **Given** 運営がルールセットを投入, **When** 保存が完了, **Then** 級位（初級〜六級）・段位（初段〜六段）・伝位（初伝〜永世名歌位）の昇格条件が読み込み可能になる
3. **Given** 不正な形式のカレンダーを投入, **When** バリデーションが実行される, **Then** エラーが返され、保存されない

---

### User Story 4 - 季末確定パイプライン（freeze→finalize→publish） (Priority: P2)

各戦（春戦/夏戦/秋戦/冬戦）の終了後、運営がfreeze→finalize→publishの3段階パイプラインを実行する。freezeで対象期間のイベントを固定し、finalizeで段位・伝位・歌位の昇格判定を行い、publishで結果をスナップショットとして公開する。publish後は結果が不変となる。

**Why this priority**: 段位以上の昇格判定と公式結果の確定に必須。級位検定（P1）の即時判定とは異なり、季末にバッチ処理で実行される。

**Independent Test**: テストデータを用いてパイプラインを実行し、各段階が正しく遷移し、結果が確定・公開されることを確認する。

**Acceptance Scenarios**:

1. **Given** 春戦が終了し未凍結状態, **When** freezeを実行, **Then** 春戦期間のイベント集合が固定され、以後のイベント追加・変更が不可になる
2. **Given** 凍結済みの春戦データ, **When** finalizeを実行, **Then** 公式記録のみを対象に段位・伝位・歌位の昇格判定が行われ、昇格結果がuser_progressに反映される
3. **Given** 確定済みの春戦結果, **When** publishを実行, **Then** season_snapshotが生成・公開され、immutableフラグがtrueに設定される
4. **Given** publish済みの春戦スナップショット, **When** 結果の変更を試みる, **Then** 変更が拒否される
5. **Given** パイプライン実行中にエラーが発生, **When** 再実行する, **Then** 冪等性が保たれ、同一結果が得られる

---

### User Story 5 - 段位・伝位・歌位の昇格判定 (Priority: P2)

季末確定（finalize）時に、公式記録のみを対象として段位（初段〜六段）・伝位・歌位の昇格判定が行われる。段位はdan_eligibleかつ全札使用の公式競技で上位一定割合以上の成績が条件。伝位・歌位は公式競技での上位入賞回数が条件。飛び段・飛び伝位は禁止（1回の確定処理で1段階のみ）。

**Why this priority**: 昇格判定は歌位システムの中核機能だが、季末パイプライン（P2-Story4）に依存するため同じP2とする。

**Independent Test**: 各種条件のテストデータを用意し、finalize実行時に正しい昇格判定が行われることを確認する。

**Acceptance Scenarios**:

1. **Given** dan_eligibleなプレイヤーが春戦で公式競技の上位半分以内に入賞, **When** finalizeが実行される, **Then** 初段に昇段し、user_progressが更新される
2. **Given** 初段のプレイヤーが上位半分かつ上位1/3以内に入賞, **When** finalizeが実行される, **Then** 二段にのみ昇段する（飛び段禁止）
3. **Given** provisionalの競技でのみ好成績を残したプレイヤー, **When** finalizeが実行される, **Then** 段位は変化しない（公式記録のみが対象）
4. **Given** dan_eligibleでないプレイヤーが好成績を残した, **When** finalizeが実行される, **Then** 段位判定の対象外となる

---

### User Story 6 - 確定結果の参照表示 (Priority: P3)

プレイヤーはpublish済みの季末スナップショットを閲覧し、自分や他のプレイヤーの歌位・段位・級位を確認できる。クライアントは読み取り専用でスナップショットを参照する。

**Why this priority**: 結果表示は重要だが、データ基盤（P1/P2）が先に必要。

**Independent Test**: publish済みスナップショットを閲覧し、昇格結果が正しく表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** publish済みの春戦スナップショットが存在, **When** プレイヤーが歌位ページを開く, **Then** 昇格結果・歌位一覧が表示される
2. **Given** 未publish（freeze中）のスナップショット, **When** プレイヤーが歌位ページを開く, **Then** 「集計中」と表示され、結果は非公開
3. **Given** プレイヤーが自分の昇格履歴を確認, **When** プロフィールを開く, **Then** 級位・段位・伝位の履歴が時系列で表示される

---

### User Story 7 - 確定ジョブの監視と再実行 (Priority: P3)

運営は確定パイプラインの実行ログ（成功/失敗/対象戦/対象件数）を確認できる。失敗したジョブは再実行でき、冪等性が保たれる。

**Why this priority**: 運用監視機能は信頼性に重要だが、コア機能の後に実装可能。

**Independent Test**: ジョブ実行後にログを確認し、失敗時の再実行で結果が一貫することを確認する。

**Acceptance Scenarios**:

1. **Given** 確定パイプラインが成功, **When** ジョブログを確認, **Then** 実行時刻・対象戦・処理件数・結果が記録されている
2. **Given** 確定パイプラインが途中で失敗, **When** 再実行する, **Then** 同一結果が得られ、二重処理されない

---

### Edge Cases

- 節気境界の正確な瞬間（例: 立春の秒単位）にイベントが開始された場合、[start_at, end_at) の半開区間ルールで正しく割り当てられるか？
- 冬戦が年をまたぐ場合（立冬2026→立春2027）、seasonYearは開始年（2026）が設定されるか？
- 節気カレンダーが未投入の年にイベントが記録された場合、どう処理するか？（エラーとする）
- 参加者数がちょうど24名の競技はofficialと判定されるか？（はい: >= 24）
- freeze後にイベントの追加や修正が試みられた場合、適切に拒否されるか？
- publish後にseason_snapshotの変更が試みられた場合、適切に拒否されるか？
- 複数戦にまたがるイベント（開始が立夏の直前、終了が立夏の直後）の場合、開始日時で判定されるか？
- ルールセットが途中で更新された場合、凍結済みの戦には旧ルールが適用されるか？（凍結時点のルールを使用）

## Requirements *(mandatory)*

### Functional Requirements

**ルールセット・カレンダー管理**

- **FR-001**: システムはルールセット（級位・段位・伝位の昇格条件定義）を保存・読み込みできなければならない
- **FR-002**: システムは年別節気カレンダー（立春/立夏/立秋/立冬/翌年立春の日時と4期間の定義）を保存・読み込みできなければならない
- **FR-003**: 節気カレンダーは必須マーカー（risshun, rikka, risshuu, rittou, risshun_next）と4期間（spring, summer, autumn, winter）のstart_at/end_atを含まなければならない

**歌合イベント管理**

- **FR-004**: システムは歌合イベント（kyui_examまたはmatch）を保存できなければならない
- **FR-005**: kyui_examイベントは、対象札範囲（決まり字上限/全札フラグ）、出題数、正解数、所要時間を記録できなければならない。各級位の最低出題数: 十級=7問、九級=10問、八級=15問、七級=25問、六級=50問
- **FR-006**: matchイベントは、参加者数、順位、全札使用フラグを記録できなければならない
- **FR-007**: matchイベントは参加者数に基づき記録格を自動判定しなければならない（24名以上: official、23名以下: provisional）
- **FR-008**: イベント開始日時（Asia/Tokyo）から節気カレンダーを参照し、四季区分（spring/summer/autumn/winter）と対象年を自動割当しなければならない
- **FR-009**: 四季区分の判定は半開区間 [start_at, end_at) で行わなければならない

**級位検定（即時昇級）**

- **FR-010**: 検定（kyui_exam）終了時に、ルールセットの条件（対象札範囲・正答率）に基づき即時昇級判定を行わなければならない。対象札範囲は決まり字数で段階的に拡大する（十級=一字決まり、九級=二字、八級=三字、七級=四字以上含む部分札、六級=全100首）
- **FR-011**: 飛び級を禁止し、1回の検定で最大1段階の昇級のみ許可しなければならない
- **FR-012**: 六級到達時にdan_eligibleフラグをuser_progressに設定しなければならない

**季末確定パイプライン**

- **FR-013**: 各戦の終了後にfreeze→finalize→publishの3段階パイプラインを実行できなければならない
- **FR-014**: freeze実行時、対象期間のイベント集合を固定し、以後の追加・変更を不可としなければならない
- **FR-015**: finalize実行時、公式記録（official）のみを対象に段位・伝位・歌位の昇格判定を行わなければならない
- **FR-016**: publish実行時、結果をseason_snapshotとして保存・公開し、不変（immutable）としなければならない
- **FR-017**: パイプラインは冪等でなければならない（同一期間の再実行で同一結果を保証）

**昇格判定ロジック**

- **FR-018**: 段位昇格はdan_eligible、全札使用の公式競技、ルールセットで定義された順位条件を全て満たす必要がある
- **FR-019**: 伝位・歌位昇格はden_eligible、公式競技での上位入賞（シーズンランキング上位1/3以内）回数がルールセット条件を満たす必要がある
- **FR-020**: 飛び段・飛び伝位を禁止し、1回のfinalize処理で最大1段階の昇格のみ許可しなければならない

**セキュリティ・権限**

- **FR-021**: 昇級・昇段・称号付与・季末確定スナップショット生成はサーバのみが実行可能でなければならない
- **FR-022**: クライアントはpublish済みスナップショットの読み取りのみ許可されなければならない
- **FR-023**: ルールセット・節気カレンダー・season_snapshot・ジョブログはクライアントからの書込を禁止しなければならない
- **FR-024**: user_progressはクライアントからの書込を禁止し、サーバ更新のみとしなければならない
- **FR-025**: イベントは作成者のみが作成・編集可能とし、status=final以降は編集不可としなければならない

**監視**

- **FR-026**: 確定パイプラインの実行ログ（ジョブ名、対象戦、開始/終了時刻、状態、エラー、統計）を保存しなければならない

### Key Entities

- **ルールセット (Ruleset)**: 級位・段位・伝位の昇格条件を定義するYAML形式の設定。バージョン管理される。
- **節気カレンダー (Season Calendar)**: 年ごとの二十四節気境界日時と四季区分期間の定義。運営が投入する。
- **歌合イベント (Event)**: 検定（kyui_exam）または競技（match）の記録。四季区分と記録格が自動割当される。
- **ユーザー進捗 (User Progress)**: プレイヤーの現在の級位・段位・伝位と、昇格に必要なカウンター・フラグを保持する。
- **季末スナップショット (Season Snapshot)**: freeze→finalize→publishの結果を保持する不変のスナップショット。昇格結果と集計情報を含む。
- **ジョブ実行ログ (Job Run)**: 確定パイプラインの実行記録。冪等性の担保と運用監視に使用。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 級位検定の合格判定は検定完了から3秒以内にプレイヤーに反映される
- **SC-002**: 歌合イベントの四季区分割当は100%正確に行われる（節気カレンダーの境界に基づく）
- **SC-003**: 季末確定パイプラインの各段階（freeze/finalize/publish）は運営が1操作で実行できる
- **SC-004**: publish済みスナップショットは変更不可であり、いかなる手段でもクライアントから書き換えできない
- **SC-005**: 確定パイプラインの再実行が前回と同一結果を返す（冪等性100%）
- **SC-006**: 飛び級・飛び段が発生するケースが0件である（全昇格が1段階のみ）
- **SC-007**: 暫定記録（provisional）が段位・伝位・歌位の判定に使用されるケースが0件である

## Assumptions

- 節気カレンダーの境界日時は外部天文APIから自動取得を試み、取得不可の場合は運営が管理画面から手動入力する
- 冬戦が年をまたぐ場合（例: 2026年立冬〜2027年立春）、seasonYearは開始年（2026）とする
- ルールセットはfreeze時点のバージョンが適用される（凍結後のルール変更は次戦から適用）
- 検定（kyui_exam）は記録格（official/provisional）の対象外（個人の受験結果であり参加者数の概念がない）
- 段位昇格に必要な「全札使用」は100首全ての百人一首札を対象とした競技を意味する
- matchイベントは既存の公式競技セッション（OfficialPage）の結果から自動生成される。手動登録は不要
- 競技の「順位」はシーズン（各戦）内のベスト3回のスコア合計によるランキングで決定される
- 本システムは既存のentries/rankings/submissionsコレクションを置き換える（マイグレーションが必要）
- den_eligibleフラグは六段到達時に付与される

## Scope Boundaries

### In Scope

- ルールセットと節気カレンダーの保存・読み込み
- 節気カレンダーの外部API自動取得（フォールバック: 手動入力）
- 歌合イベント（検定/競技）記録の保存と自動分類
- 既存の公式競技セッションからmatchイベントの自動生成
- シーズン内累積スコアによる順位決定
- 級位検定の即時昇級判定
- 季末確定パイプライン（freeze→finalize→publish）
- 段位・伝位・歌位の昇格判定
- 確定結果のスナップショット公開と不変性保証
- ジョブ実行ログの保存と冪等性
- Firestore Security Rulesによるサーバ権限の担保
- 既存のentries/rankings/submissionsシステムの節気ベースシステムへの置き換え

### Out of Scope

- 外部の公式段位制度との連携・証明
- リアル大会運営（会場、対戦組み、配信等）
- 旧暦（太陰太陽暦）での月齢計算（節気ベースのみ）
- クライアント側UI/UXの詳細設計（別仕様として策定）
