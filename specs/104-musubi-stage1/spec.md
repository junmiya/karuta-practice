# Feature Specification: 結び（段階1：結び＋集い）

**Feature Branch**: `104-musubi-stage1`
**Created**: 2026-02-07
**Status**: Draft
**Input**: 結び（団体）段階1 — 結びの作成・参加・管理と集い（スケジュール枠）のUI。成績/ランキング/歌位には一切介入しない。

## Principles

1. 既存の成績・ランキング・歌位ロジックには一切介入しない（段階1では read/write ともに対象外）
2. 「結び」トップはユーザー混乱防止のため必ず二分割（集い／団体歌合）にする
3. 「集い」は既存の団体内イベントデータを継続利用し、スケジュール枠のまま（成績に影響しない）
4. すべての書き込みはサーバ経由で認証・認可（既存方針を踏襲）
5. データベース直書きは禁止（既存ルールを踏襲）

## Clarifications

### Session 2026-02-07

- Q: 集いの状態遷移（draft/published/closed）の可視性は？ → A: draft は主宰者/世話役のみ表示。published で全メンバーに公開。主宰者は集いをリジェクト（却下）できる。
- Q: 結びのプロフィール編集（名前・説明）は段階1に含めるか？ → A: 段階1では作成のみ。編集は段階2に先送り。
- Q: 招待コード検証のレート制限は段階1で必要か？ → A: 段階1では省略。コード長を16文字以上のランダム英数字にすることでブルートフォースリスクを低減。

## Terminology

| アプリ内表記 | 意味 | 備考 |
|------------|------|------|
| 結び | 団体・グループ | UI上で「団体」「グループ」は表示しない |
| 集い | 結び内イベント（スケジュール枠） | 成績に影響しない |
| 団体歌合 | 結び対抗の公式競技 | 段階1では「準備中」表示のみ |

## Tab Structure

**変更前**: 手習 / 稽古 / 歌合 / 歌位
**変更後**: 手習 / 稽古 / 歌合 / **結び** / 歌位

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 結びを作成する (Priority: P1)

認証済みユーザーが新しい結びを作成し、主宰者（owner）になる。作成と同時に招待コードが発行され、他のユーザーを招待できるようになる。

**Why this priority**: 結びが存在しなければ他のすべての機能が成り立たない。最も基本的な機能。

**Independent Test**: 結びタブから「結びを作る」を押し、名前を入力して作成。結びホームが表示され招待コードが確認できれば成功。

**Acceptance Scenarios**:

1. **Given** 認証済みユーザーが結びタブを開いている, **When** 「結びを作る」を押して名前（1〜50文字）を入力し作成, **Then** 結びが作成され、自分が主宰者として登録され、招待コードが発行される
2. **Given** 同名の活動中の結びが存在する, **When** 同じ名前で結びを作ろうとする, **Then** エラーメッセージが表示され作成されない
3. **Given** 名前が空または51文字以上, **When** 作成を試みる, **Then** バリデーションエラーが表示される

---

### User Story 2 - 招待コードで結びに参加する (Priority: P1)

認証済みユーザーが招待コード入力またはQRコード読み取りで結びに参加し、一般メンバーになる。

**Why this priority**: 結びに仲間が集まらなければ価値がない。作成と同等に重要。

**Independent Test**: 招待コードを入力フォームに貼り付けて参加ボタンを押す。結びホームが表示されれば成功。QRコードからのディープリンクでも同一の検証ロジックで参加できることを確認。

**Acceptance Scenarios**:

1. **Given** 有効な招待コードを持っている, **When** コード入力フォームで送信する, **Then** 結びに一般メンバーとして参加し、結びホームが表示される
2. **Given** QRコードを読み取る, **When** ディープリンク（`/musubi/join?groupId=xxx&code=yyy`）が開かれる, **Then** ログイン済みなら自動的に参加処理が行われる（未ログインならログイン画面へ誘導後に参加）
3. **Given** 期限切れの招待コード, **When** 参加を試みる, **Then** 「招待コードの期限が切れています」エラー
4. **Given** 上限に達した招待コード, **When** 参加を試みる, **Then** 「招待コードの利用上限に達しました」エラー
5. **Given** 無効化された招待コード, **When** 参加を試みる, **Then** 「招待コードは無効です」エラー
6. **Given** 既にその結びのメンバー, **When** 再度参加を試みる, **Then** 「既にメンバーです」メッセージ

---

### User Story 3 - 結びホームを閲覧する（二分割表示） (Priority: P1)

結びのメンバーが結びホームを開くと、「集い」と「団体歌合」の2セクションが表示される。団体歌合は段階1では「準備中」表示。

**Why this priority**: 結びの中核的なナビゲーション。段階2への拡張を前提とした構造。

**Independent Test**: 結びホームを開き、「集い」セクション（イベント一覧への導線あり）と「団体歌合（準備中）」セクションが表示されることを確認。

**Acceptance Scenarios**:

1. **Given** 結びのメンバーが結びホームを開く, **When** ページが読み込まれる, **Then** 「集い」セクションと「団体歌合」セクションが表示される
2. **Given** 結びホームを開く, **When** 「団体歌合」セクションを確認する, **Then** 「準備中」と表示されアクション不可
3. **Given** 結びのメンバーでないユーザー, **When** 結びホームのURLに直接アクセスする, **Then** 結びの基本情報（名前・メンバー数）のみ表示される

---

### User Story 4 - 招待コードを管理する（主宰者のみ） (Priority: P2)

主宰者が招待コードの再生成・無効化・QR表示を行える。

**Why this priority**: 安全な招待管理のために必要。メンバー管理に直結。

**Independent Test**: 主宰者として結びの管理画面から招待コード再生成・QR表示・無効化を実行し、各操作後の状態を確認。

**Acceptance Scenarios**:

1. **Given** 主宰者が結び管理画面を開く, **When** 「コードを再生成」を押す, **Then** 旧コードが無効化され新コードが発行される
2. **Given** 主宰者が管理画面を開く, **When** 「QRを表示」を押す, **Then** 参加URL付きQRコードが表示される
3. **Given** 主宰者が管理画面を開く, **When** 「コードを無効化」を押す, **Then** 現在のコードが無効になり、以降の参加ができなくなる
4. **Given** 世話役（organizer）が管理画面を開く, **When** 招待コード操作を試みる, **Then** 操作ボタンが表示されない（権限なし）
5. **Given** 招待操作が行われる, **When** 操作が完了する, **Then** 監査ログに記録される

---

### User Story 5 - 集い（イベント）を作成・閲覧する (Priority: P2)

主宰者または世話役が集い（スケジュール枠）を作成・編集する。メンバーは一覧と詳細を閲覧する。

**Why this priority**: 結びの活動の基本単位。成績には影響しない安全なスケジュール機能。

**Independent Test**: 主宰者として集い作成画面でタイトル・日時を入力して作成。一覧に表示されること、一般メンバーが閲覧できることを確認。

**Acceptance Scenarios**:

1. **Given** 主宰者が集い一覧を開く, **When** 「集いを作る」を押してタイトル・開始日時・終了日時を入力する, **Then** 集いが作成され一覧に表示される
2. **Given** 世話役が集い一覧を開く, **When** 集い作成を行う, **Then** 同様に作成可能
3. **Given** 一般メンバーが集い一覧を開く, **When** 作成ボタンを探す, **Then** 作成ボタンが表示されない
4. **Given** 集いが作成されている, **When** メンバーが集い詳細を開く, **Then** タイトル・日時・説明が表示される
5. **Given** 集いが作成・編集される, **When** 操作が完了する, **Then** 監査ログに記録される

---

### User Story 6 - メンバーとロールを管理する（主宰者のみ） (Priority: P3)

主宰者がメンバー一覧を確認し、ロール変更（世話役への昇格・降格）やメンバー除外を行える。

**Why this priority**: メンバー管理は結び運営に必要だが、最初期は主宰者が少人数で運営する想定のため優先度を下げる。

**Independent Test**: 主宰者としてメンバー一覧を開き、特定メンバーのロール変更と除外を実行。変更が反映されることを確認。

**Acceptance Scenarios**:

1. **Given** 主宰者がメンバー一覧を開く, **When** メンバーのロールを「世話役」に変更する, **Then** ロールが更新される
2. **Given** 主宰者がメンバー一覧を開く, **When** メンバーを除外する, **Then** メンバーが結びから外れる
3. **Given** 世話役がメンバー一覧を開く, **When** ロール変更を試みる, **Then** 操作ボタンが表示されない

---

### Edge Cases

- 結びの主宰者が自ら脱退しようとした場合 → 主宰者は脱退不可（先にオーナー移譲が必要）
- 招待コード再生成中に他ユーザーが旧コードで参加しようとした場合 → トランザクションで整合性を保証
- 同一ユーザーが同じ結びに対して同時に2回参加リクエストを送信した場合 → メンバーシップの一意性で重複防止
- 結びが停止・削除状態の場合に招待コードで参加しようとした場合 → 「この結びは現在利用できません」エラー
- 集いの終了日時が開始日時より前の場合 → バリデーションエラー
- 結びのメンバー数が非常に大きい場合（100人超） → ページネーション対応（段階1ではデフォルト上限100のため実質不要）

## Requirements *(mandatory)*

### Functional Requirements

#### タブ・ナビゲーション

- **FR-001**: タブ構成が「手習 / 稽古 / 歌合 / 結び / 歌位」の5タブになること
- **FR-002**: 結びタブは未認証ユーザーにはログイン誘導を表示すること

#### 結びの作成・参加

- **FR-003**: 認証済みユーザーが結びを作成できること（名前1〜50文字、説明500文字以内）
- **FR-004**: 結び作成時に主宰者としてのメンバーシップと招待コードが同時に作成されること
- **FR-005**: 同名の活動中の結びが存在する場合、作成を拒否すること
- **FR-006**: 招待コードは16文字以上のランダム英数字で生成し、ハッシュ化して保存すること（平文保存禁止）
- **FR-007**: 招待コードのデフォルト有効期限は7日、デフォルト上限は100回であること
- **FR-008**: 招待コードの検証は、ハッシュ一致 AND 期限内 AND 上限未達 AND 無効化されていないことを確認すること
- **FR-009**: QRコードによる参加URLは `/musubi/join?groupId={id}&code={code}` 形式であること
- **FR-010**: QRからの参加とコード入力からの参加は同一の検証ロジックを使用すること

#### 結びホーム

- **FR-011**: 結びホームに「集い」セクションと「団体歌合」セクションを常時表示すること
- **FR-012**: 「団体歌合」セクションは段階1では「準備中」と表示しアクション不可とすること
- **FR-013**: メンバーでないユーザーには結びの基本情報（名前・メンバー数）のみ表示すること

#### 招待コード管理

- **FR-014**: 主宰者のみが招待コードの再生成・無効化・QR表示を行えること
- **FR-015**: コード再生成時は旧コードを自動的に無効化すること

#### 集い（イベント）

- **FR-016**: 主宰者と世話役が集いを作成・編集できること
- **FR-017**: 一般メンバーは集い一覧と詳細を閲覧のみ可能であること（published/closed のみ表示）
- **FR-018**: 集いはスケジュール枠であり、成績集計に一切影響しないこと
- **FR-026**: 集いの状態遷移は draft → published → closed とし、draft は主宰者/世話役のみに表示されること
- **FR-027**: 主宰者は集いをリジェクト（却下）できること。リジェクトされた集いは一般メンバーに表示されないこと

#### ロール・権限

- **FR-019**: ロールは主宰者（owner）・世話役（organizer）・一般メンバー（member）の3種であること
- **FR-020**: 主宰者のみがロール変更・メンバー除外を行えること
- **FR-021**: 主宰者は脱退不可であること（オーナー移譲が先に必要）
- **FR-022**: すべての書き込み操作はサーバサイドで認証・認可チェックを行うこと
- **FR-023**: データベースへのクライアント直接書き込みは禁止すること

#### 監査ログ

- **FR-024**: 招待操作（作成・再生成・無効化）・メンバー加入/脱退・集い作成/編集がログに記録されること

#### スコープ制限

- **FR-025**: 段階1では試合記録（sessions）、個人イベント記録（events）、ランキング（rankings）に対する変更を一切行わないこと

### Key Entities

- **結び（Group）**: ユーザーが集まる団体。名前・説明・主宰者・メンバー数・状態を持つ
- **メンバーシップ（Membership）**: ユーザーと結びの関係。ロール（主宰者/世話役/一般）・状態（活動中/脱退済）・加入日時を持つ
- **招待コード（Invite）**: 結びへの参加手段。ハッシュ化コード・有効期限・上限回数・利用回数・無効化日時を持つ
- **集い（Group Event）**: 結び内のスケジュール枠。タイトル・開始/終了日時・公開範囲・状態（draft/published/rejected/closed）を持つ。draft は主宰者/世話役のみ表示。主宰者がリジェクト可能。成績に影響しない
- **監査ログ（Audit Log）**: 操作履歴。実行者・操作種別・対象・詳細・日時を持つ

## Scope Boundaries

### In Scope

- 結びタブUI導線追加（5タブ構成）
- 結びの作成/参加/管理のUI（既存データ構造を利用）
- 招待コード参加（コード入力＋QRディープリンク）
- 結びトップ二分割（集い／団体歌合[準備中]）
- 集い：一覧/作成/詳細（スケジュール枠のみ）
- ロールに基づくUI制御（主宰者/世話役/一般メンバー）
- 監査ログ（招待・加入・集い作成/編集）

### Out of Scope

- 団体順位/団体歌合の集計・表示（段階2以降）
- 試合記録/シーズン/ランキング/更新処理への変更（段階2以降）
- 個人イベント記録の仕様変更（段階1では触らない）
- 集いを成績集計に影響させること（禁止）
- 結びのプロフィール編集（名前・説明の変更）（段階2以降）

## Assumptions

- 認証済みユーザーであれば誰でも結びを作成可能（管理者制限なし）
- 1ユーザーが作成できる結びの数に上限はない（段階1）
- 結びへの参加は招待コードのみ（公開検索による参加はない）
- QRコード表示はフロントエンドで生成する（サーバサイドでの画像生成は不要）
- 集いの参加登録機能は段階1ではオプション（一覧表示と詳細閲覧が必須）
- UI上の「団体」「グループ」表記はすべて「結び」に統一する

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーが結びの作成を30秒以内に完了できる
- **SC-002**: 招待コード入力による結び参加を20秒以内に完了できる
- **SC-003**: QRコード読み取りから結び参加完了まで30秒以内
- **SC-004**: 結びホームで「集い」と「団体歌合（準備中）」の2セクションが即座に識別できる
- **SC-005**: 招待コードの異常系（期限切れ・上限超過・無効化・不一致）の100%でエラーメッセージが表示される
- **SC-006**: 段階1の実装前後で、既存の歌合スコア・ランキング・歌位データに差分がない
- **SC-007**: 主宰者以外のユーザーが招待コード管理・ロール変更を実行できないことが100%保証される
