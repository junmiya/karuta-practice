# Feature Specification: 手引タブ（導入・遊び方・友招待）増設

**Feature Branch**: `105-tebiki-invite`
**Created**: 2026-02-08
**Status**: Draft
**Input**: 百人一首の楽しさを30秒で伝え、初見ユーザーを「手習→稽古→歌合」へ導く手引タブと、友人招待（同条件で開始）のMVP実装

## Clarifications

### Session 2026-02-08

- Q: 招待リンクのIDと招待コードの関係は？ → A: 別の識別子。リンクには長いUUID（inviteId）、コードは短い6文字英数字（inviteCode）。両方同じInviteドキュメントを指す2つのルックアップキー。
- Q: 招待コードの入力場所はどこか？ → A: 手引ページの「友を誘う」セクション内にコード入力欄を配置。専用ルートは不要。
- Q: 手引ページのURLパスは？ → A: `/tebiki`。既存ルートの日本語ローマ字パターンと統一。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 手引ページで百人一首の楽しさを知り、手習を始める (Priority: P1)

初めてアプリを訪れたユーザーが、ナビの「手引」タブから手引ページを開く。30秒で百人一首の楽しさ（決まり字の快さ、上達の実感、友との歌合）を理解し、「一首ためす」ボタンから手習を即座に開始できる。

**Why this priority**: 初見ユーザーの離脱を防ぎ、最初の体験（手習）へ繋げる最も重要な導線。招待機能がなくても、この画面だけで初見ユーザーに価値を提供できる。

**Independent Test**: 手引ページを表示し、序文・百首のこと・遊びの手順・FAQの各セクションが表示されること、「一首ためす」CTAが手習ページへ遷移することを確認。ログイン不要で完結する。

**Acceptance Scenarios**:

1. **Given** 未ログインの初見ユーザー, **When** ナビの「手引」タブをタップ, **Then** 手引ページが表示され、序文セクションに百人一首の楽しさを伝える4文と「一首ためす」「友を誘う」のCTAが表示される
2. **Given** 手引ページを閲覧中, **When** 「一首ためす」CTAをタップ, **Then** 手習ページ（`/`）へ遷移する
3. **Given** 手引ページを閲覧中, **When** 「友を誘う」CTAをタップ, **Then** ページ内の招待セクションへスクロールする
4. **Given** 手引ページを閲覧中, **When** 「百首のこと」セクションを確認, **Then** 読札・取札・決まり字の説明と面白みの要約が表示される
5. **Given** 手引ページを閲覧中, **When** 「遊びの手順」セクションを確認, **Then** はじめて・覚える・友との3ステップがカード形式で表示され、各カードにCTAがある

---

### User Story 2 - ログイン済みユーザーが友人への招待を作成する (Priority: P2)

ログイン済みユーザーが手引ページの「友を誘う」セクションから招待を作成する。対象モード（手習・稽古・歌合）を選び、招待リンクと招待コードを取得してコピーし、友人に共有する。

**Why this priority**: 友人招待はユーザー獲得の重要な手段であり、手引ページだけでは提供できない付加価値を生む。ただし手引ページが先に必要。

**Independent Test**: ログイン済み状態で招待を作成し、リンクとコードが表示・コピーできること、24時間後に期限切れになることを確認。

**Acceptance Scenarios**:

1. **Given** ログイン済みユーザーが手引ページの招待セクションを表示, **When** 対象モード（手習・稽古・歌合）を選択して「招待を作る」をタップ, **Then** 招待リンクと招待コードが生成・表示される
2. **Given** 招待リンクが表示されている, **When** コピーボタンをタップ, **Then** リンクがクリップボードにコピーされ、コピー完了通知が表示される
3. **Given** 招待コードが表示されている, **When** コピーボタンをタップ, **Then** コードがクリップボードにコピーされ、コピー完了通知が表示される
4. **Given** 未ログインユーザーが招待セクションを表示, **When** 「招待を作る」をタップ, **Then** ログインを促す導線が表示される

---

### User Story 3 - 友人が招待リンクから参加して同条件で開始する (Priority: P2)

招待を受けた友人が、招待リンクを開く（またはコード入力画面でコードを入力する）。招待内容を確認し、「参加する」ボタンを押すと、招待者と同じ条件で対象モードが開始される。

**Why this priority**: 招待作成（US2）と同じ優先度。招待の作成と参加はセットで価値を提供する。

**Independent Test**: 有効な招待リンクを開き、参加画面が表示され、「参加する」で正しいモードへ遷移することを確認。URLパラメータで設定が引き継がれることを確認。

**Acceptance Scenarios**:

1. **Given** 有効な招待リンクを受け取った友人, **When** リンクを開く, **Then** 招待参加画面に「同じ条件で始めます」と対象モード名が表示され、「参加する」CTAがある
2. **Given** 招待参加画面を表示中, **When** 「参加する」をタップ, **Then** 対象モードの開始URLへリダイレクトされ、招待時の設定がURLパラメータとして適用される
3. **Given** 対象モードがログイン必須（稽古・歌合）, **When** 未ログインの友人が「参加する」をタップ, **Then** ログイン画面へ誘導され、ログイン完了後に対象モードへリダイレクトされる
4. **Given** 招待コード入力画面, **When** 有効なコードを入力して「参加する」をタップ, **Then** 招待リンクからの参加と同様に対象モードが開始される

---

### User Story 4 - 期限切れ・無効な招待へのフォールバック (Priority: P3)

招待リンクが期限切れまたは無効だった場合、ユーザーに分かりやすいメッセージを表示し、手習への導線を提供してユーザーを失わない。

**Why this priority**: エラーケースの対応は必須だが、正常系（US1-3）が先に動く必要がある。

**Independent Test**: 期限切れの招待リンクを開いてエラーメッセージと「一首ためす」フォールバックCTAが表示されることを確認。

**Acceptance Scenarios**:

1. **Given** 期限切れの招待リンクを開いた, **When** 参加画面が表示される, **Then** 「期限切れです」メッセージと「一首ためす」フォールバックCTAが表示される
2. **Given** 存在しない招待IDを含むリンクを開いた, **When** 参加画面が表示される, **Then** 「招待が見つかりません」メッセージと「一首ためす」フォールバックCTAが表示される
3. **Given** フォールバックCTAが表示されている, **When** 「一首ためす」をタップ, **Then** 手習ページ（`/`）へ遷移する

---

### Edge Cases

- 招待作成者自身が自分の招待リンクを開いた場合 → 通常通り参加画面を表示（自己参加を制限しない）
- 同一招待リンクを複数人が使用した場合 → 各参加者がそれぞれ独立して対象モードを開始できる（使用回数の制限はMVPでは設けない）
- 短時間に大量の招待コード入力試行があった場合 → ブルートフォース対策として試行回数制限を推奨（MVP任意）
- 招待作成後に作成者がログアウトした場合 → 招待は有効なまま（作成者のログイン状態に依存しない）
- ブラウザ非対応・JavaScript無効の場合 → 対応範囲外（既存アプリと同様）

## Requirements *(mandatory)*

### Functional Requirements

**ナビゲーション**

- **FR-001**: グローバルナビに「手引」タブを追加し、タブ順序は「手引・手習・稽古・歌合・結び・歌位」とする。手引ページのURLは `/tebiki`
- **FR-002**: 初回訪問ユーザーに対し、「手引」タブへの誘導バナーを表示する。バナーは閉じることができ、閉じた状態は保持される

**手引ページ**

- **FR-003**: 手引ページに以下5つのセクションを表示する: 序文（30秒でわかる）、百首のこと、遊びの手順、友を誘う、よくある問い
- **FR-004**: 序文セクションに百人一首の楽しさを伝える固定文（4文）と「一首ためす」（プライマリ）・「友を誘う」（セカンダリ）のCTAを表示する
- **FR-005**: 「百首のこと」セクションに読札・取札・決まり字の説明と面白みの要約を表示する
- **FR-006**: 「遊びの手順」セクションに3ステップ（はじめて・覚える・友と）をカード形式で表示し、各カードにCTAを設ける
- **FR-007**: 「よくある問い」セクションに最低3つのFAQ（決まり字とは？、招待リンクが開けない／期限切れ、ログインが必要な場面）を表示する
- **FR-008**: 手引ページはログイン不要で閲覧できる

**招待作成**

- **FR-009**: ログイン済みユーザーは招待を作成できる。対象モードとして手習・稽古・歌合のいずれかを選択する
- **FR-010**: 招待作成時、招待リンク（必須）と招待コード（推奨）を生成して表示する
- **FR-011**: 招待リンクと招待コードにはそれぞれコピーボタンを設け、コピー結果をユーザーに通知する
- **FR-012**: 招待の有効期限はMVPでは24時間固定とする
- **FR-013**: 招待の設定（表示オプション・フィルタ）はMVPではデフォルト固定とする（以下参照）

**MVP デフォルト設定（招待作成時）**

| 設定項目             | MVPデフォルト値      | URLパラメータ名   | 備考                         |
| -------------------- | -------------------- | ----------------- | ---------------------------- |
| 読札かな表示         | off（漢字）          | `yomiKana=1`      | 1=かな, 省略=漢字            |
| 取札かな表示         | off（漢字）          | `toriKana=1`      | 同上                         |
| 決まり字表示         | off                  | `kimariji_show=1` | 1=表示, 省略=非表示          |
| 決まり字フィルタ     | なし（全札）         | `kimariji=1,2,…`  | カンマ区切り                 |
| 歌番号範囲           | なし（全100首）      | `range=1-20,…`    | 省略=全首                    |

MVPでは招待作成UIにこれらの入力欄は設けず、すべてデフォルト（全札・漢字・決まり字非表示）で固定する。Phase2で選択UIを追加可能（データモデルに`settings`フィールドは用意しておく）。

**招待参加**

- **FR-014**: 招待リンクを開くと参加画面が表示され、招待内容（対象モード名）と「参加する」CTAが表示される
- **FR-015**: 招待コードによる参加もサポートする。コード入力欄は手引ページの「友を誘う」セクション内に配置する（専用ルート不要）
- **FR-016**: 「参加する」操作後、対象モードの開始URLへリダイレクトし、招待時の設定をURLパラメータとして適用する
- **FR-017**: 対象モードがログイン必須の場合、未ログインユーザーにはログイン誘導を行い、ログイン完了後に参加を継続する

**targetMode → URL ルートマッピング**

| targetMode (DB) | 日本語ラベル | ランディングURL | 開始URL                 | 認証必須 |
| --------------- | ------------ | --------------- | ----------------------- | -------- |
| `tenarai`       | 手習         | `/tenarai`      | `/practice?{params}`    | No       |
| `keiko`         | 稽古         | `/keiko`        | `/practice12?{params}`  | Yes      |
| `utaawase`      | 歌合         | `/utaawase`     | `/utaawase`             | Yes      |

招待参加後のリダイレクト先は「開始URL」にsettingsをURLパラメータとして付与する。

**INV-03 設定適用の検証方法**

招待参加後の設定適用はURLパラメータ方式で実現する（KeikoPage→Practice12Pageと同じパターン）。検証手順:

1. 招待リンクを開く（例: `/invite/join?id=abc123`）
2. 「参加する」ボタン押下
3. リダイレクト先URLに正しいパラメータが含まれることを確認（例: `/practice12?yomiKana=1&toriKana=1`）
4. DevTools > Network でリダイレクト先URLを検証
5. 画面上で表示オプションが招待時の設定に一致していることを目視確認

**エラーハンドリング**

- **FR-018**: 期限切れの招待にアクセスした場合、「期限切れです」メッセージと「一首ためす」フォールバックCTAを表示する
- **FR-019**: 存在しない・無効な招待にアクセスした場合、「招待が見つかりません」メッセージと「一首ためす」フォールバックCTAを表示する
- **FR-020**: 招待コードの過剰試行に対するブルートフォース対策を推奨する（MVP任意）

### Key Entities

- **招待（Invite）**: 招待リンク/コードの本体。inviteId（長いUUID、リンク用）、inviteCode（6文字英数字、手入力用）、作成者ユーザーID、作成日時、有効期限、ステータス（active/expired/revoked）、対象モード（tenarai/keiko/utaawase）、設定（yomiKana, toriKana, kimarijiShow, kimarijiFilter, poemRange）、使用回数、最終使用日時を持つ。inviteIdとinviteCodeは同一ドキュメントへの2つのルックアップキー
- **招待参加者（InviteParticipant）**（任意）: 招待を利用して参加したユーザーの記録。招待ID、参加者ユーザーID（または匿名セッションID）、参加日時を持つ

## Scope *(mandatory)*

### In Scope

- グローバルナビに「手引」タブを追加（タブ順序変更）
- 手引ページの5セクション（序文・百首のこと・遊びの手順・友を誘う・FAQ）の実装
- 初回訪問バナー（手引タブへの誘導、dismissible）
- 招待リンク・コードの作成（ログイン必須）
- 招待リンク・コードによる参加と設定の適用
- 期限切れ・無効招待のエラー画面とフォールバック導線

### Out of Scope

- 歌合のリアルタイム同期（同時開始、読み上げ同期、勝敗判定の高度化）
- 参加者一覧・戦績共有の高度化（Phase2以降）
- 招待作成時の設定カスタマイズUI（Phase2で追加予定、MVPはデフォルト固定）
- 招待使用回数の上限制限
- 招待の取消し（revoke）UI

## Assumptions

- 既存のナビゲーション（Header.tsx）にタブを追加する構造が対応可能
- URLパラメータ方式による設定引き継ぎは、既存のKeikoPage→Practice12Pageパターンを踏襲
- 手引ページのコンテンツは静的（CMS不要、コード内にハードコード可）
- 招待コード（inviteCode）は6文字の英数字で、推測困難かつ衝突しにくい生成方法を用いる。招待リンクのID（inviteId）は別途長いUUIDを使用する
- 招待リンクは `/invite/join?id={inviteId}` 形式

## Dependencies

- 既存のナビゲーション構造（Header.tsx の TabButton パターン）
- 既存のルーティング構造（react-router-dom 6）
- 既存の手習・稽古・歌合ページのURLパラメータ対応
- Firebase認証（ログイン必須機能のため）
- Firestoreデータベース（招待データの永続化）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 初見ユーザーが手引ページを開いてから30秒以内に「一首ためす」CTAを発見・タップできる
- **SC-002**: 招待リンクの作成からコピーまで15秒以内に完了できる
- **SC-003**: 招待リンクを開いた友人が「参加する」から対象モード開始まで2タップ以内で到達できる（ログイン不要モードの場合）
- **SC-004**: 期限切れ・無効な招待リンクを開いた場合、100%の確率でフォールバック導線（「一首ためす」）が表示される
- **SC-005**: 手引ページの全セクション（序文・百首のこと・遊びの手順・友を誘う・FAQ）がログイン不要で閲覧できる
- **SC-006**: 招待参加後のリダイレクト先URLに正しい設定パラメータが含まれ、画面上で設定が反映されている
