# Feature Specification: 百人一首競技カルタアプリ完全仕様

**Feature Branch**: `101-karuta-app-spec`
**Created**: 2026-01-18
**Status**: Draft
**Input**: User description: 百人一首・競技カルタの学習〜公式競技（番付）までを提供するWebアプリケーション

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 学習タブで札を閲覧して覚える (Priority: P1)

ユーザーはログインなしで百人一首の札一覧を閲覧し、決まり字フィルタやひらがな表示切替を使いながら札を覚えることができる。「覚えた」フラグを付けた札は除外/優先表示が可能。

**Why this priority**: 学習はアプリの入口機能であり、ログイン不要で全ユーザーがアクセスできるため、ユーザー獲得の第一歩となる。

**Independent Test**: ゲストユーザーとして札一覧を表示し、決まり字フィルタ・ひらがな切替・覚えたトグル・シャッフルが動作することを確認できる。

**Acceptance Scenarios**:

1. **Given** 学習タブにアクセスしたゲストユーザー, **When** 画面を開く, **Then** 12枚の札がグリッド表示される（横向き=4×3、縦向き=3×4）
2. **Given** 札一覧が表示されている状態, **When** 「ひらがな」ボタンをタップ, **Then** 表示が漢字かな交じり⇔ひらがなで切り替わる
3. **Given** 札一覧が表示されている状態, **When** 決まり字フィルタで「1字決まり」を選択, **Then** 1字決まりの札のみがフィルタされる
4. **Given** 札が表示されている状態, **When** 札をタップして「覚えた」トグルをON, **Then** その札が覚えた状態として記録される
5. **Given** 札一覧が表示されている状態, **When** 「シャッフル」ボタンをタップ, **Then** 現在の条件を維持したまま12枚が再抽選される

---

### User Story 2 - 研鑽タブでクイズ形式の練習をする (Priority: P2)

ログインしたユーザーは、決まり字数を選択して読札（上の句）から取札（下の句）を選ぶクイズ形式の練習ができる。正解率・平均解答時間・札別傾向が記録される。

**Why this priority**: 研鑽は学習の次のステップであり、ユーザーの定着と上達を促進する。番付には影響しない安全な練習環境。

**Independent Test**: ログインユーザーとして研鑽モードを開始し、読札表示→取札選択→正解/不正解判定→結果サマリー表示の一連のフローが動作することを確認できる。

**Acceptance Scenarios**:

1. **Given** 研鑽タブにアクセスしたログインユーザー, **When** 決まり字数（1〜6）を選択して開始, **Then** 選択された決まり字数の札からクイズが出題される
2. **Given** クイズが表示されている状態, **When** 取札を選択, **Then** 正解/不正解が即座に判定され、解答時間がミリ秒単位で記録される
3. **Given** 複数問回答した状態, **When** 結果サマリーを表示, **Then** 正解率・平均解答時間・札別傾向が表示される
4. **Given** 研鑽モードで記録された成績, **When** 成績タブで確認, **Then** 個人成績として閲覧できるが、番付には反映されない

---

### User Story 3 - 競技タブで公式競技セッションを実施する (Priority: P3)

エントリー済みのログインユーザーは、50問の公式競技セッションを実施できる。セッション完了後、サーバーで検証・確定され、公式記録として番付に反映される。

**Why this priority**: 公式競技は本アプリのコア価値であり、ユーザーのモチベーションと継続利用を促進する。

**Independent Test**: エントリー済みユーザーとして公式競技を開始し、50問回答→提出→サーバー確定→番付反映の一連のフローが動作することを確認できる。

**Acceptance Scenarios**:

1. **Given** エントリー済みのログインユーザー, **When** 競技タブで「開始」をタップ, **Then** 公式競技セッションが開始され、60分のタイマーが開始される
2. **Given** 公式競技セッション中, **When** 50問すべてに回答, **Then** セッションを提出できる
3. **Given** セッションを提出した状態, **When** サーバーで検証が完了, **Then** 異常がなければ「confirmed」として公式記録に反映される
4. **Given** 公式競技セッション中, **When** 60分を超過, **Then** セッションは「expired」となり、番付には反映されない
5. **Given** 公式競技セッション中, **When** ひらがな/決まり字/覚えた/シャッフルボタンをタップ, **Then** 公平性のため操作がロックされている（または確認ダイアログが表示される）

---

### User Story 4 - 成績タブで個人成績と番付を閲覧する (Priority: P4)

ログインユーザーは、自分の個人成績（正解率・平均解答時間・決まり字別傾向など）と、公式番付（過去シーズン上位者・現シーズン順位）を閲覧できる。

**Why this priority**: 成績と番付の可視化はユーザーの達成感とモチベーション維持に不可欠。

**Independent Test**: ログインユーザーとして成績タブを開き、個人成績の各指標と番付表示が正しく表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 成績タブにアクセスしたログインユーザー, **When** 個人成績セクションを表示, **Then** 正解率・平均解答時間・分散・決まり字別成績が表示される
2. **Given** 成績タブにアクセスしたログインユーザー, **When** 番付セクションを表示, **Then** 過去シーズン上位3名（殿堂）と現シーズン上位100名が表示される
3. **Given** エントリー済みのユーザー, **When** 現シーズン番付を表示, **Then** 自分がエントリーした部門（級位の部/段位の部）の番付のみが表示される（混在禁止）
4. **Given** 番付表示, **When** 他ユーザーの情報を確認, **Then** ニックネームのみが表示される（プライバシー保護）

---

### User Story 5 - シーズンにエントリーする (Priority: P5)

ログインユーザーは、現在のシーズンの「級位の部」または「段位の部」にエントリーできる。段位の部は六級保有が必要。同一シーズン内で両方にエントリーすることはできない。

**Why this priority**: エントリーは公式競技参加の前提条件であり、競技機能を有効化するために必要。

**Independent Test**: ログインユーザーとしてエントリー画面を開き、部門選択→同意確認→エントリー完了の一連のフローが動作することを確認できる。

**Acceptance Scenarios**:

1. **Given** ログインユーザーがエントリー画面を開く, **When** 部門を選択してエントリー, **Then** 番付公開への同意確認後、エントリーが完了する
2. **Given** 六級未保有のユーザー, **When** 段位の部を選択しようとする, **Then** エントリーできない旨のメッセージが表示される
3. **Given** すでに級位の部にエントリー済みのユーザー, **When** 段位の部にエントリーしようとする, **Then** 同一シーズン内での重複エントリー不可のメッセージが表示される
4. **Given** エントリー済みのユーザー, **When** エントリーをキャンセル, **Then** エントリーが解除される（返金なし）

---

### Edge Cases

- 公式競技セッション中にネットワーク切断が発生した場合：
  - **自動保存**: 各round回答時にFirestoreへ即時保存（オフライン時はローカルキャッシュ）
  - **再開条件**: セッション開始から60分以内かつstatus='in_progress'
  - **再開UI**: 競技タブアクセス時に未完了セッションを検出し「続きから再開」ダイアログを表示
  - **超過時**: status='expired'に自動更新、番付反映なし
- 異常検知（clientElapsedMs<200msが5回以上、または>60000msが1回でも）：セッションは「invalid」となり番付反映なし
- 参加者が24名未満のシーズン：名人/永世称号は付与されない
- 冬戦（年またぎ）のseasonId：開始年で管理（例：2025_winter）

## Requirements *(mandatory)*

### Functional Requirements

#### ナビゲーション・アクセス制御

- **FR-001**: システムは4つの主要タブ（学習・研鑽・競技・成績）を順番に表示しなければならない
- **FR-002**: 学習タブはゲスト（未ログイン）ユーザーでもアクセス可能でなければならない
- **FR-003**: 研鑽・競技・成績タブはログイン必須でなければならない

#### UI固定ルール

- **FR-004**: 全モードで札枚数は12枚固定でなければならない
- **FR-005**: グリッド配置は画面の向きに応じて自動切替（横向き=4×3、縦向き=3×4）しなければならない
- **FR-006**: 札の縦横比は73:52を維持しなければならない
- **FR-007**: コントロールバーには「ひらがな」「決まり字」「覚えた」「シャッフル」ボタンを順番に配置しなければならない
- **FR-008**: タッチターゲットは最小44pxを確保しなければならない
- **FR-009**: PC表示時は最大幅1200pxを超えないようにしなければならない
- **FR-010**: 札テキストはTokensごとに折り返し（yomiTokens/toriTokens配列の各要素で改行）、それ以外の位置での自動折返しは禁止。オーバーフローはフォント/余白/最小表示モードで吸収しなければならない

#### 学習タブ

- **FR-011**: 学習タブは札一覧のグリッド表示を提供しなければならない
- **FR-012**: 決まり字フィルタ（1〜6字決まり選択）を提供しなければならない
- **FR-013**: 「覚えた」フラグによる除外/優先表示を提供しなければならない
  - **除外モード**: 覚えた札を抽選対象から除外（未習得札のみ表示）
  - **優先モード**: 覚えた札を優先的に抽選（復習用）
  - **通常モード**: 覚えた状態を無視して全札から抽選（デフォルト）
  - **UI**: ControlBarの「覚えた」ボタンをトグル式で3状態切替（通常→除外→優先→通常...）
- **FR-014**: ひらがな切替（漢字かな交じり⇔かな）を提供しなければならない
- **FR-015**: シャッフル（現在の条件を維持して12枚再抽選）を提供しなければならない

#### 研鑽タブ

- **FR-016**: 決まり字数（1〜6）を選択してクイズを開始できなければならない
- **FR-017**: 読札（上の句）から取札（下の句）を選ぶクイズ形式でなければならない
- **FR-018**: 解答時間をミリ秒単位で計測しなければならない
- **FR-019**: 正解率・平均解答時間・札別傾向を記録しなければならない
- **FR-020**: 研鑽の成績は番付に影響してはならない（個人成績のみ）

#### 競技タブ

- **FR-021**: 公式競技セッションは50問固定でなければならない
- **FR-022**: セッション開始にはエントリーが必須でなければならない
- **FR-023**: セッションは60分で有効期限切れとなり、expiredとなる
- **FR-024**: 公式競技中はひらがな/決まり字/覚えた/シャッフルボタンをロック（または確認ダイアログ）しなければならない
- **FR-025**: セッション提出後、サーバー側で検証・確定しなければならない
- **FR-026**: 異常検知ルールを適用しなければならない：
  - round数不一致（50未満/重複/欠番）→invalid
  - 選択肢整合性NG（selectedがchoices外、choices不足等）→invalid
  - 極端値（clientElapsedMs<200msが5回以上、または>60000msが1回でも）→invalid

#### 成績タブ

- **FR-027**: 個人成績（正解率・平均解答時間・分散・決まり字別・札別傾向）を表示しなければならない
- **FR-028**: 殿堂（過去全シーズンの上位3名）を表示しなければならない
- **FR-029**: 現シーズン番付（上位100名）を表示しなければならない
- **FR-030**: 番付にはニックネームのみを表示しなければならない（プライバシー保護）
- **FR-031**: 番付表示はユーザーのエントリー部門に一致するもののみ（混在禁止）

#### エントリー・部門

- **FR-032**: ユーザーは「級位の部」または「段位の部」のいずれか一方にのみエントリーできる
- **FR-033**: 段位の部へのエントリーは六級保有が必要
- **FR-034**: シーズン途中の段位取得でも当該シーズンは区分変更不可
- **FR-035**: エントリーには番付公開への同意が必須
- **FR-036**: エントリーはシーズン中いつでも可能、キャンセル可能（返金なし）

#### シーズン・称号

- **FR-037**: シーズンは年4回（春戦・夏戦・秋戦・冬戦）
- **FR-038**: seasonIdはYYYY_{spring|summer|autumn|winter}形式（冬戦は開始年を採用）
- **FR-039**: 名人称号は段位の部finalized番付1位を4回達成で付与（連続不要）
- **FR-040**: 永世称号は段位の部finalized番付1位を8回達成で付与（連続不要）
- **FR-041**: 参加者24名未満のシーズンでは称号付与なし
- **FR-042**: 参加者の定義は「confirmedの公式競技セッション10回達成者」

#### キャッシュ・更新

- **FR-043**: 番付キャッシュは3時間ごとにサーバー側で更新
- **FR-044**: クライアントは都度集計せず、サーバー生成キャッシュを参照

### Key Entities

- **Poem（札）**: poemId, order, yomi, yomiKana, tori, toriKana, yomiTokens, yomiKanaTokens, toriTokens, toriKanaTokens, yomiNoSpace, yomiKanaNoSpace, toriNoSpace, toriKanaNoSpace, kimariji, kimarijiCount, author
- **User（ユーザー）**: uid, nickname, currentRank, titles[], entries[]
- **Entry（エントリー）**: userId, seasonId, division, consentedAt
- **OfficialSession（公式競技セッション）**: sessionId, userId, seasonId, division, status(created/in_progress/submitted/confirmed/invalid/expired), rounds[], submittedAt, confirmedAt
- **Round（ラウンド）**: roundIndex (0-49), correctPoemId, selectedPoemId, choices[], clientElapsedMs, isCorrect
- **Ranking（番付）**: seasonId, division, rank, userId, nickname, score, participantCount

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ゲストユーザーが学習タブで札一覧を表示し、フィルタ・切替操作を完了するまで3秒以内
- **SC-002**: 研鑽モードでクイズ回答後、正解/不正解判定が100ms以内に表示される
- **SC-003**: 公式競技50問セッションの提出からサーバー確定まで10秒以内
- **SC-004**: 番付表示（100名分）のロード時間が2秒以内
- **SC-005**: 公式競技セッションの異常検知精度95%以上（不正セッションの検出率）
- **SC-006**: 番付公開ユーザーの100%がプライバシー同意を完了している
- **SC-007**: グリッド表示が横向き⇔縦向き切替時に0.5秒以内で再配置される
- **SC-008**: 札の縦横比73:52がすべての画面サイズで維持される

## Assumptions

- 歌データ（poems.seed.json）はクライアントに事前に読み込まれている
- Firebase認証が利用可能で、ログイン状態の管理はFirebase Authに依存
- サーバーサイド処理はCloud Functionsで実行される
- 日次集計の境界はJST 00:00〜23:59
- 節気データ（立春〜立夏など）はA案で確定済み、固定データとして利用
