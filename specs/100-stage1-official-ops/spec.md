# 段階1: 公式競技運用自動化

## 概要

段階1では「公式競技の運用を"自動で回る状態"にする」ことを最優先とし、番付・称号・集計・公開の整合性を担保する。

## スコープ

段階1は以下を提供する：

1. **シーズン（年4回）の自動運用**
2. **番付の公式確定（凍結→確定→公開）**
3. **日別上位3セット反映**
4. **称号カウント**
5. **成績の可視化強化**

---

## シーズン管理

### シーズンスケジュール
- シーズンは年4回（spring/summer/autumn/winter）
- 冬は年またぎでも開始年でseasonIdを命名する（YYYY_winter）
- seasonIdは `YYYY_{spring|summer|autumn|winter}`（英語固定）
  - 例：2026_spring, 2026_winter

### シーズン状態
シーズン状態は以下の順で遷移する：

```
open → frozen → finalized → archived
```

| 状態 | 説明 |
|------|------|
| open | 競技受付中 |
| frozen | 集計停止（確定準備） |
| finalized | 確定公開 |
| archived | 保管 |

### 凍結→確定ルール
- 凍結→確定の判定は「確定時点」で行う
- 確定後は原則再計算しない（重大不正のみ再計算し告知）

---

## 集計ルール

### 母集団
- 集計母集団は `confirmed` かつ `isRankEligible=true` の「反映セットのみ」とする

### 日次集計
- 日次集計は **JST 00:00〜23:59** とする

### 日別反映
- 日別上位3セット反映は「日次トップ3（セッション単位）」を記録
- 後続の番付スコアに反映できる構造とする

### タイブレーク
- 同点時の比較は `lastReflectedSubmittedAt` を使用
- これが小さい（早い）方を上位にする

### 丸め・閾値
| ルール | 方式 |
|--------|------|
| 上位50%等の閾値判定 | ceil（切り上げ） |
| bonus等の丸め | 四捨五入（0.5以上切り上げ） |
| スコア負値 | `max(0, score)` を適用 |

---

## 公式競技

### セッション
- 公式競技は1セッション **50問固定**（roundCount=50）

### エントリー
- エントリーはシーズン中いつでも可能
- 取り消し可（返金なし）
- 同一シーズン同時エントリー部門は1つまで
- 段位の部へのエントリーは **六級保有** が必要
- シーズン開始時点の区分で固定し途中変更しない

---

## 番付

### 公開ルール
- 番付に表示するのは **表示名（ニックネーム）のみ**
- 掲載は **事前同意が必須**（同意しないとエントリー不可）
- 番付は「公式」として扱い、`finalized`状態のスナップショットのみを"公式結果"として公開

### 部門分離
- ランキング混在を避けるため、部門（級位/段位）とランキングは **完全分離**
- 同一UIでも結果は別テーブル

---

## 称号

### 称号ルール
- 称号は **段位の部** の `finalized` 番付1位をカウント対象とする
- 最低参加者 **24名以上** が条件

| 称号 | 条件 |
|------|------|
| 名人 | 4回 |
| 永世 | 8回（連続条件なし） |

---

## 成績可視化

成績画面で以下を可視化する：

- 正解率
- 平均解答時間
- 分散
- 決まり字別正答率
- 日別上位3反映回数

---

## 異常値判定

段階0の5条件に加え、段階1で拡張可能な設計とする：

1. round数不一致（50未満、重複）
2. 選択肢整合性NG（selectedPoemIdがchoices外）
3. 極端な高速（clientElapsedMs < 200ms が5回以上）
4. 極端な低速（clientElapsedMs > 60000ms が1回でも）
5. 範囲外（correctCountが0〜50の範囲外）
6. **[段階1拡張]** 分布逸脱（極端短時間が多数など）

---

## 課金

- 課金は **月額自動更新**
- 解約後は次回更新日まで利用可能
- **返金なし**
- 利用停止中もデータは保持（成績は閲覧不可だが保持）

---

## Cloud Functions

段階0のCallable 1本に加え、段階1でScheduled Functionsを本格運用：

| 種別 | 用途 |
|------|------|
| Callable | `submitOfficialSession`（公式記録確定） |
| Scheduled | シーズン状態遷移 |
| Scheduled | 日次集計 |
| Scheduled | 凍結時の最終集計 |
| Scheduled | 確定スナップショット作成 |
| Scheduled | 称号カウント更新 |

---

## UI統一ルール（段階0から継承）

### 不変ルール
| ルール | 値 |
|--------|-----|
| 札枚数 | 12枚固定 |
| グリッド | 4×3固定 |
| 縦横比 | 73:52 |
| スクロール | 札グリッドでスクロール禁止 |

### 画面構造
全端末で共通化：
1. top_bar
2. control_bar
3. card_grid
4. bottom_status

### control_bar
- 主要ボタンは常時表示、順序固定：[ひらがな][決まり字][覚えた][シャッフル]
- トグル状態（ON/OFF）は色だけに依存せず、ラベル/状態表示を必須

### レスポンシブ
| 条件 | 動作 |
|------|------|
| 幅640px未満 | control_barを2行化可（順序維持） |
| 幅640px以上 | 1行固定 |
| PC | 最大幅1100〜1200pxで中央寄せ |

### 最小表示モード
viewport高さ不足時は以下の順で調整：
1. 上下余白削減
2. control_bar 2行化（mobile）
3. 文字縮小
4. padding縮小

### 公式競技中のUIロック
- 公式競技中はUI変更が記録の公平性に影響するため、ひらがな/決まり字/覚えた/シャッフルは原則ロック
- 必要なら確認ダイアログを表示
