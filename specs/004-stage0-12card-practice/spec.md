# Feature Specification: 段階0 12枚固定練習UI・公式競技・番付

**Feature Branch**: `004-stage0-12card-practice`
**Created**: 2026-01-18
**Status**: Draft
**Input**: 段階0の12枚固定練習UI、公式競技50問、公式番付機能の実装（憲法v7.0.0に基づく）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 12枚固定の基本練習 (Priority: P1)

ユーザーは百人一首の練習を行いたい。画面に12枚の取札が4×3のグリッドで表示され、読み上げられた上の句に対応する下の句を選択する。ログイン不要で何度でも練習できる。

**Why this priority**: 基本練習は全ユーザーが最初に体験する機能であり、サービスの価値を示す最重要機能。ログイン不要で気軽に使えることで、ユーザー獲得の入口となる。

**Independent Test**: ログインせずにトップページから練習を開始し、12枚の札から正解を選んで次の問題に進めることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーがトップページにアクセスした状態, **When** 「練習を開始する」ボタンをタップする, **Then** 12枚の取札が4×3グリッドで表示され、上の句が読み上げ表示される
2. **Given** 12枚の取札が表示されている状態, **When** 正しい取札をタップする, **Then** 正解表示とともに次の問題に進む
3. **Given** 12枚の取札が表示されている状態, **When** 誤った取札をタップする, **Then** 不正解表示とともに正解が示され、次の問題に進む
4. **Given** 練習中の状態, **When** 「ひらがな」ボタンをタップする, **Then** 全ての札表示がひらがなに切り替わる
5. **Given** 練習中の状態, **When** 「決まり字」選択を変更する, **Then** 次のシャッフル時に選択した決まり字数の歌のみから出題される
6. **Given** 練習中の状態, **When** 「シャッフル」ボタンをタップする, **Then** 現在の条件を維持したまま12枚が再抽選される

---

### User Story 2 - 公式競技への参加 (Priority: P2)

ログイン済みのユーザーは、シーズンにエントリーして公式競技（50問セッション）に参加できる。結果はサーバーで検証・確定され、公式記録として番付に反映される。

**Why this priority**: 公式競技は本サービスの核心機能。練習だけでなく「公式に記録される」ことで、ユーザーのモチベーションと継続利用につながる。

**Independent Test**: ログインしてエントリー後、50問を完了し、結果が「確定済み」となり番付に反映されることを確認する。

**Acceptance Scenarios**:

1. **Given** ログイン済みユーザーがシーズン開催中の状態, **When** 「エントリー」ボタンをタップし同意する, **Then** 級位の部または段位の部にエントリーされる
2. **Given** エントリー済みユーザーの状態, **When** 「公式競技を開始」ボタンをタップする, **Then** 50問のセッションが開始される
3. **Given** 公式競技中の状態, **When** 50問すべてに回答する, **Then** 結果がサーバーに提出される
4. **Given** 結果が提出された状態, **When** サーバーが検証を完了する, **Then** 異常がなければ「confirmed」となり番付に反映される
5. **Given** 結果が提出された状態, **When** サーバーが異常を検出する, **Then** 「invalid」となり番付には反映されず「参考記録」として表示される

---

### User Story 3 - 公式番付の閲覧 (Priority: P3)

ユーザーは現在のシーズンの公式番付（ランキング）を閲覧できる。番付には確定済みの公式記録のみが反映され、ニックネームで表示される。

**Why this priority**: 番付は競技性とモチベーションの源泉。自分の順位を確認し、他のプレイヤーと競い合う楽しさを提供する。

**Independent Test**: 番付ページにアクセスし、級位の部・段位の部それぞれのランキングが表示され、自分の順位が確認できることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが番付ページにアクセスした状態, **When** ページが読み込まれる, **Then** 現在のシーズンの級位の部・段位の部のランキングが表示される
2. **Given** ログイン済みでエントリー済みのユーザー, **When** 番付を閲覧する, **Then** 自分の順位がハイライト表示される
3. **Given** 番付が表示された状態, **When** 部門を切り替える, **Then** 選択した部門のランキングに表示が切り替わる

---

### User Story 4 - 覚えた札の管理 (Priority: P4)

ログイン済みユーザーは、練習中に「覚えた」ボタンで札を覚えたとしてマークできる。覚えた札は練習から除外または優先するオプションが選べる。

**Why this priority**: 学習効率を高める機能。初心者が段階的に覚えていく過程を支援する。

**Independent Test**: 練習中に「覚えた」ボタンを押し、その札が覚えたリストに追加されることを確認する。

**Acceptance Scenarios**:

1. **Given** ログイン済みで練習中の状態, **When** 札の「覚えた」ボタンをタップする, **Then** その札が「覚えた」としてマークされる
2. **Given** 覚えた札がある状態, **When** 練習設定で「覚えた札を除外」を選択する, **Then** 覚えた札は出題されなくなる

---

### Edge Cases

- セッション開始から60分経過した場合、そのセッションは「expired」となり公式記録にならない
- 同一シーズンに級位の部と段位の部の両方にエントリーしようとした場合、エラーとなる
- 段位の部にエントリーしようとしたが六級を保有していない場合、エラーとなる
- ネットワーク切断により結果提出に失敗した場合、再送信を促すメッセージが表示される
- 200ms未満の回答が5回以上ある場合、異常値として「invalid」となる

---

## Requirements *(mandatory)*

### Functional Requirements

**練習UI（基本モード）**

- **FR-001**: システムは12枚の取札を4×3グリッドで表示しなければならない
- **FR-002**: 札の縦横比は縦:横=73:52を維持しなければならない
- **FR-003**: ユーザーは「ひらがな」ボタンで表示を漢字かな交じり⇔ひらがなに切り替えられなければならない
- **FR-004**: ユーザーは「決まり字」選択で出題範囲を絞り込めなければならない（1字〜6字決まり）
- **FR-005**: ユーザーは「シャッフル」ボタンで現在の条件を維持したまま12枚を再抽選できなければならない
- **FR-006**: 練習モードはログイン不要で利用できなければならない

**公式競技**

- **FR-007**: ログイン済みユーザーのみが公式競技にエントリーできなければならない
- **FR-008**: エントリーには番付掲載への同意が必須でなければならない
- **FR-009**: 公式競技は1セッション50問固定でなければならない
- **FR-010**: セッション開始から60分経過で自動的に「expired」となりなければならない
- **FR-011**: 結果はサーバー側で検証・確定され、クライアントからの直接書き込みは禁止されなければならない
- **FR-012**: 異常値が検出された場合は「invalid」となり番付に反映されてはならない

**エントリー・部門**

- **FR-013**: ユーザーは「級位の部」または「段位の部」のいずれか一方にのみエントリーできなければならない
- **FR-014**: 段位の部へのエントリーは六級保有者のみに許可されなければならない
- **FR-015**: シーズン開始時点の区分で固定され、途中の段位取得でも当該シーズンは区分変更されてはならない

**番付**

- **FR-016**: 番付には確定済み（confirmed）の公式記録のみが反映されなければならない
- **FR-017**: 番付にはニックネームのみが表示され、個人を特定できる情報は表示されてはならない
- **FR-018**: シーズンごと・部門ごとにランキングが表示されなければならない

**覚えた機能**

- **FR-019**: ログイン済みユーザーは札を「覚えた」としてマークできなければならない
- **FR-020**: 覚えた札は練習時に除外または優先するオプションが選べなければならない（段階0は保存のみでも可）

### Key Entities

- **Poem（歌）**: 百人一首の歌データ。poemId、order（1-100）、yomi/yomiKana（上の句）、tori/toriKana（下の句）、kimariji/kimarijiCount（決まり字）、author（作者）を持つ
- **User（ユーザー）**: サービス利用者。uid、nickname（表示名）、banzukeConsent（番付同意）、rank（級位/段位）を持つ
- **Season（シーズン）**: 年4回の競技期間。seasonId（例：2026_spring）、開始日・終了日、ステータスを持つ
- **Entry（エントリー）**: ユーザーのシーズン参加情報。uid、seasonId、division（kyu/dan）、同意日時を持つ
- **Session（セッション）**: 公式競技の1セット。50問の回答データと結果を含む。status（created/in_progress/submitted/confirmed/invalid/expired）で状態管理
- **Ranking（番付）**: シーズン×部門ごとのランキングデータ。確定済みセッションのスコアに基づく順位情報

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーはトップページから3タップ以内で練習を開始できる
- **SC-002**: 12枚の札が画面内に収まり、スクロールなしで全て視認できる（スマホ縦画面含む）
- **SC-003**: 札の縦横比73:52が全デバイスで維持される
- **SC-004**: 公式競技の50問を15分以内に完了できる（平均的なユーザー）
- **SC-005**: 結果提出から番付反映まで30秒以内に完了する
- **SC-006**: 番付ページの初回表示が3秒以内に完了する
- **SC-007**: 異常値検出の精度が99%以上である（不正な記録の誤検出・見逃しが1%未満）
- **SC-008**: 同時接続100ユーザーでもパフォーマンス劣化なく動作する

---

## Assumptions

- 歌データ（poems.seed.json）は100首すべてが正確であり、クライアントに同梱される
- Firebase Authenticationでログイン機能が既に実装されている（001-phase0-foundationで対応済み）
- Blazeプランが有効化されており、Cloud Functionsが利用可能である
- シーズン情報は管理者が手動で設定する（自動生成は段階1以降）
- 初回リリース時のシーズンは「2026_spring」とする
